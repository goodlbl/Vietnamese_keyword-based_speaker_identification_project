<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¤ PhÃ²ng {{ room.id }} â€“ GiÃ¡m sÃ¡t giá»ng nÃ³i 24/24</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            text-align: center;
            padding: 60px;
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
        }
        h1 { font-size: 28px; margin-bottom: 10px; }
        #status { margin-top: 20px; font-size: 18px; }
        #result { margin-top: 25px; font-size: 20px; font-weight: bold; }
        .ok { color: #00ffb3; }
        .fail { color: #ff7675; }
        .pulse { animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>ğŸ¤ PhÃ²ng {{ room.id }} â€“ GiÃ¡m sÃ¡t giá»ng nÃ³i 24/24</h1>
    <p>Há»‡ thá»‘ng Ä‘ang hoáº¡t Ä‘á»™ng liÃªn tá»¥c, nháº­n diá»‡n giá»ng nÃ³i cá»§a báº¡n má»—i vÃ i giÃ¢y.</p>
    <p id="status" class="pulse">ğŸ§ Äang khá»Ÿi Ä‘á»™ng microphone...</p>
    <p id="result"></p>

    <script>
        const status = document.getElementById("status");
        const result = document.getElementById("result");

        let stream = null;
        let recording = false;
        const RECORD_DURATION = 4000;  // ghi 4 giÃ¢y
        const LOOP_INTERVAL = 8000;    // chu ká»³ 8 giÃ¢y/láº§n

        async function startContinuousListening() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                status.textContent = "ğŸ™ï¸ Há»‡ thá»‘ng Ä‘ang nghe 24/24...";
                status.classList.add("pulse");
                startRecordingLoop();
            } catch (err) {
                console.error("âŒ KhÃ´ng thá»ƒ truy cáº­p microphone:", err);
                status.textContent = "âŒ KhÃ´ng thá»ƒ truy cáº­p microphone. HÃ£y báº­t quyá»n mic.";
                status.classList.remove("pulse");
            }
        }

        function startRecordingLoop() {
            setInterval(async () => {
                if (recording) return;
                recording = true;

                // ğŸ—£ï¸ Hiá»‡n thÃ´ng bÃ¡o hÆ°á»›ng dáº«n ngÆ°á»i dÃ¹ng nÃ³i keyword
                status.textContent = "ğŸ™ï¸ HÃ£y nÃ³i tá»« khÃ³a cá»§a báº¡n...";

                const mediaRecorder = new MediaRecorder(stream);
                const chunks = [];

                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: "audio/wav" });
                    const formData = new FormData();
                    formData.append("audio", blob, "voice.wav");

                    try {
                        const res = await fetch("{% url 'action_room:verify_voice' %}", {
                            method: "POST",
                            body: formData
                        });
                        const data = await res.json();

                        // ğŸ§  Pháº£n há»“i tá»« Flask API
                        if (data.similarity && data.similarity >= 0) {
                            const sim = parseFloat(data.similarity);
                            if (sim >= 0.8) {
                                // âœ… NgÆ°á»i há»£p lá»‡
                                const name = data.name || "NgÆ°á»i dÃ¹ng há»£p lá»‡";
                                const role = data.role || "ÄÆ°á»£c phÃ©p truy cáº­p";
                                result.innerHTML = `âœ… <span class="ok">${name} â€“ Quyá»n: ${role}</span><br>
                                                     (Äá»™ khá»›p ${(sim*100).toFixed(1)}%)`;
                            } else {
                                // âŒ NgÆ°á»i láº¡
                                result.innerHTML = `ğŸš« <span class="fail">NgÆ°á»i láº¡ â€“ KhÃ´ng cÃ³ quyá»n truy cáº­p</span><br>
                                                     (Äá»™ khá»›p ${(sim*100).toFixed(1)}%)`;
                            }
                        } else {
                            result.innerHTML = `âš ï¸ ${data.error || "KhÃ´ng thá»ƒ nháº­n dáº¡ng"}`;
                        }

                    } catch (err) {
                        console.error("âš ï¸ Lá»—i gá»­i API:", err);
                        result.textContent = "âš ï¸ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n server Flask.";
                    }

                    recording = false;
                    status.textContent = "ğŸ§ Há»‡ thá»‘ng tiáº¿p tá»¥c nghe...";
                };

                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), RECORD_DURATION);
            }, LOOP_INTERVAL);
        }

        // ğŸš€ Tá»± khá»Ÿi Ä‘á»™ng khi trang load
        window.addEventListener("load", startContinuousListening);
    </script>
</body>
</html>
