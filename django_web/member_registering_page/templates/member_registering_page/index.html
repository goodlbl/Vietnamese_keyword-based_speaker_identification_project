<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quad Team</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f2f2f2;
        }

        header {
            background-color: #007BFF;
            color: white;
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            padding: 30px 0;
        }

        .name-input {
            text-align: center;
            margin: 30px 0;
        }
        .name-input input {
            width: 60%;
            padding: 12px 15px;
            font-size: 18px;
            border: 2px solid #007BFF;
            border-radius: 6px;
            outline: none;
        }

        .instruction {
            text-align: center;
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
        }

        .audio-section {
            display: flex;
            justify-content: space-around;
            margin: 20px auto;
            width: 90%;
        }

        .audio-box {
            background-color: white;
            border: 2px solid #007BFF;
            border-radius: 12px;
            padding: 20px;
            width: 30%;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .audio-box h3 {
            margin-top: 0;
            color: #007BFF;
        }

        .audio-box button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .audio-box button.recording {
            background-color: red;
        }

        .spacer { height: 40px; }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 60%;
            margin: 0 auto;
        }

        .button-grid button {
            width: 100%;
            padding: 25px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn1 { background-color: #FF5733; }
        .btn2 { background-color: #33FF57; }
        .btn3 { background-color: #3357FF; }
        .btn4 { background-color: #FF33A1; }
        .btn5 { background-color: #FF8C33; }
        .btn6 { background-color: #33FFF2; }

        .off { filter: brightness(0.6) grayscale(0.3); }

        .corner-button {
            position: fixed;
            bottom: 20px;
            padding: 15px 25px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .bottom-right { right: 20px; background-color: #007BFF; }
        .bottom-left { left: 20px; background-color: red; }
    </style>
    <script>
        const csrftoken = '{{ csrf_token }}';
    </script>

</head>
<body>

<header>Quad team</header>

<!-- √î nh·∫≠p t√™n -->
<div class="name-input">
    <input type="text" id="username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
</div>

<!-- D√≤ng h∆∞·ªõng d·∫´n -->
<div class="instruction">
    B·∫°n h√£y ƒë·ªçc theo c√°c c·ª•m sau ƒë√¢y ƒë·ªÉ l√†m m·∫´u so s√°nh
</div>

<!-- 3 √¥ thu √¢m -->
<div class="audio-section">
    <div class="audio-box" id="rec1">
        <h3>‚ÄúQuad team ∆°i‚Äù</h3>
        <button onclick="toggleRecord(1)">üéôÔ∏è B·∫Øt ƒë·∫ßu thu</button>
        <audio controls id="player1" style="display:none;"></audio>
    </div>
    <div class="audio-box" id="rec2">
        <h3>‚ÄúM·ªü l√™n Quad team ∆°i‚Äù</h3>
        <button onclick="toggleRecord(2)">üéôÔ∏è B·∫Øt ƒë·∫ßu thu</button>
        <audio controls id="player2" style="display:none;"></audio>
    </div>
    <div class="audio-box" id="rec3">
        <h3>‚ÄúQuad team ∆°i th·∫ø n√†o‚Äù</h3>
        <button onclick="toggleRecord(3)">üéôÔ∏è B·∫Øt ƒë·∫ßu thu</button>
        <audio controls id="player3" style="display:none;"></audio>
    </div>
</div>

<div class="spacer"></div>

<!-- 6 n√∫t tr·∫°ng th√°i -->
<div class="button-grid">
    <button class="btn1 off" onclick="toggleBtn(1)">B·∫øp</button>
    <button class="btn2 off" onclick="toggleBtn(2)">Ti vi</button>
    <button class="btn3 off" onclick="toggleBtn(3)">M√°y l·∫°nh</button>
    <button class="btn4 off" onclick="toggleBtn(4)">Qu·∫°t</button>
    <button class="btn5 off" onclick="toggleBtn(5)">Qu·∫°t tr·∫ßn</button>
    <button class="btn6 off" onclick="toggleBtn(6)">ƒê√®n</button>
</div>

<!-- N√∫t g√≥c -->
<button class="corner-button bottom-left" onclick="resetAll()">Quay l·∫°i</button>
<button class="corner-button bottom-right" onclick="sendAll()">ƒêƒÉng k√Ω</button>

<script>
let recorders = {};
let audioChunks = {};
let streams = {};
let audioBlobs = {};  // l∆∞u 3 file audio
let buttonStates = [0,0,0,0,0,0];  // 6 n√∫t tr·∫°ng th√°i

async function toggleRecord(id) {
    const btn = document.querySelector(`#rec${id} button`);
    const player = document.querySelector(`#player${id}`);

    if (!recorders[id]) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            streams[id] = stream;
            const recorder = new MediaRecorder(stream);
            audioChunks[id] = [];

            recorder.ondataavailable = e => audioChunks[id].push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(audioChunks[id], { type: 'audio/webm' });
                audioBlobs[id] = blob;
                const url = URL.createObjectURL(blob);
                player.src = url;
                player.style.display = 'block';
                player.onplay = () => { 
                    setTimeout(() => player.pause(), 2500); 
                };
            };

            recorder.start();
            recorders[id] = recorder;
            btn.textContent = "‚èπ ƒêang thu...";
            btn.classList.add("recording");

            // T·ª± d·ª´ng sau 2.5s
            setTimeout(() => {
                if (recorders[id]) {
                    recorders[id].stop();
                    streams[id].getTracks().forEach(track => track.stop());
                    recorders[id] = null;
                    btn.textContent = "üéôÔ∏è B·∫Øt ƒë·∫ßu thu";
                    btn.classList.remove("recording");
                }
            }, 2500);

        } catch (err) {
            alert("Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c micro: " + err.message);
        }
    } else {
        // N·∫øu b·∫•m l·∫°i khi ƒëang thu th√¨ d·ª´ng ngay
        recorders[id].stop();
        streams[id].getTracks().forEach(track => track.stop());
        recorders[id] = null;
        btn.textContent = "üéôÔ∏è B·∫Øt ƒë·∫ßu thu";
        btn.classList.remove("recording");
    }
}

function toggleBtn(i) {
    const btn = document.querySelector(`.btn${i}`);
    buttonStates[i-1] = 1 - buttonStates[i-1];
    btn.classList.toggle("off");
}

function resetAll() {
    document.getElementById("username").value = "";
    buttonStates = [0,0,0,0,0,0];
    for (let i=1; i<=6; i++) document.querySelector(`.btn${i}`).classList.add("off");
    audioBlobs = {};
    alert("ƒê√£ reset to√†n b·ªô.");
}

async function sendAll() {
    const name = document.getElementById("username").value.trim();
    if (!name) return alert("H√£y nh·∫≠p t√™n tr∆∞·ªõc khi g·ª≠i.");

    const formData = new FormData();
    formData.append("name", name);
    formData.append("buttons", JSON.stringify(buttonStates));

    for (let i = 1; i <= 3; i++) {
        if (audioBlobs[i]) formData.append(`audio${i}`, audioBlobs[i], `sample${i}.webm`);
    }

    const resp = await fetch("/member_registering_page/submit_all/", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": csrftoken }
    });

    const data = await resp.json();

    if (data.success) {
        window.location.href = data.redirect_url;  // ‚úÖ chuy·ªÉn trang
    } else {
        alert("‚ùå G·ª≠i th·∫•t b·∫°i: " + (data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
    }
}


</script>
</body>
</html>
