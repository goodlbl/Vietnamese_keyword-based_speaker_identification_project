<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≠ch xu·∫•t Embedding √Çm thanh</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        input[type="file"] { display: block; margin: 15px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .result-box { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #e9ecef; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 14px; background-color: #f8f9fa; padding: 10px; border-radius: 4px; }
        .status { margin-top: 10px; font-weight: bold; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>

<div class="container">
    <h1>üéôÔ∏è Tr√≠ch xu·∫•t Speaker Embedding (MFAConformer)</h1>

    <input type="file" id="audioFile" accept="audio/*">
    <button onclick="uploadAudio()">Tr√≠ch xu·∫•t Embedding</button>

    <div class="result-box">
        <div class="status" id="statusMessage">ƒêang ch·ªù t·ªáp...</div>
        <div class="status" id="dimMessage"></div>
        <hr>
        <strong>Embedding (192 chi·ªÅu):</strong>
        <pre id="embeddingOutput">Nh·∫•n n√∫t ƒë·ªÉ b·∫Øt ƒë·∫ßu qu√° tr√¨nh tr√≠ch xu·∫•t.</pre>
    </div>
</div>

<script>
    const API_URL = '/audio_model/extract/'; // Ph·∫£i kh·ªõp v·ªõi URL Django c·ªßa b·∫°n

    async function uploadAudio() {
        const fileInput = document.getElementById('audioFile');
        const file = fileInput.files[0];
        const statusMessage = document.getElementById('statusMessage');
        const dimMessage = document.getElementById('dimMessage');
        const embeddingOutput = document.getElementById('embeddingOutput');

        if (!file) {
            statusMessage.textContent = '‚ùå Vui l√≤ng ch·ªçn m·ªôt t·ªáp √¢m thanh.';
            statusMessage.className = 'status error';
            return;
        }

        statusMessage.textContent = '‚è≥ ƒêang t·∫£i l√™n v√† x·ª≠ l√Ω m√¥ h√¨nh...';
        statusMessage.className = 'status';
        embeddingOutput.textContent = 'ƒêang x·ª≠ l√Ω...';
        dimMessage.textContent = '';
        
        try {
            // 1. Chu·∫©n b·ªã FormData ƒë·ªÉ g·ª≠i t·ªáp
            const formData = new FormData();
            // T√™n tr∆∞·ªùng ph·∫£i l√† 'audio_file' ƒë·ªÉ kh·ªõp v·ªõi request.FILES['audio_file'] trong views.py
            formData.append('audio_file', file); 

            // 2. G·ª≠i y√™u c·∫ßu POST
            const response = await fetch(API_URL, {
                method: 'POST',
                body: formData
                // Django API c·∫ßn b·ªè qua Content-Type khi d√πng FormData
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // 3. X·ª≠ l√Ω k·∫øt qu·∫£ th√†nh c√¥ng
                statusMessage.textContent = '‚úÖ Tr√≠ch xu·∫•t th√†nh c√¥ng!';
                statusMessage.className = 'status success';
                
                dimMessage.textContent = `Chi·ªÅu: ${data.embedding_dim}`;

                // Hi·ªÉn th·ªã 5 ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n v√† cu·ªëi c√πng ƒë·ªÉ l√†m v√≠ d·ª•
                const embedding = data.embedding;
                const display = `[${embedding.slice(0, 5).map(e => e.toFixed(4)).join(', ')}, ..., ${embedding.slice(-5).map(e => e.toFixed(4)).join(', ')}]`;
                
                embeddingOutput.textContent = display;
                
            } else {
                // 4. X·ª≠ l√Ω l·ªói t·ª´ server (response.status != 200 ho·∫∑c data.success == false)
                const errorMessage = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß.';
                statusMessage.textContent = `‚ùå L·ªói: ${errorMessage}`;
                statusMessage.className = 'status error';
                embeddingOutput.textContent = 'Kh√¥ng th·ªÉ tr√≠ch xu·∫•t embedding.';
            }

        } catch (error) {
            // 5. X·ª≠ l√Ω l·ªói k·∫øt n·ªëi m·∫°ng/fetch
            console.error('L·ªói Fetch:', error);
            statusMessage.textContent = `‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`;
            statusMessage.className = 'status error';
            embeddingOutput.textContent = 'L·ªói k·∫øt n·ªëi m·∫°ng.';
        }
    }
</script>

</body>
</html>